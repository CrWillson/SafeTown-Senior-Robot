<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SafeTown Senior Robot: Scheduler tick sources</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../clipboard.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">SafeTown Senior Robot
   </div>
   <div id="projectbrief">Arduino workspace for SafeTown Senior Robot development.</div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(1); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d4/dc5/md__safe_town_01_arduino_01_workspace_2libraries_2_free_r_t_o_s_2doc_2tick__sources.html','../../'); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Scheduler tick sources</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md20"></a></p>
<h1><a class="anchor" id="autotoc_md21"></a>
Configuration</h1>
<p>Tick source is selected by (un)defining values <code>portUSE_WDTO</code> and <code>portUSE_TIMER0</code> in file <code><a class="el" href="../../d0/dce/_free_r_t_o_s_variant_8h_source.html">FreeRTOSVariant.h</a></code>. Default in Arduino_FreeRTOS is Watchdog timer (WDT), it contains all code needed for this and works out-of-the-box.</p>
<p>For alternative tick source, pieces of code must be provided by the application. Arduino_FreeRTOS expects you to provide function <code>void prvSetupTimerInterrupt(void)</code> responsible for the initialisation of your tick source. This function is called after the Arduino's initialisation and before the FreeRTOS scheduler is launched.</p>
<p>NOTE: Reconfiguring Timer0 for FreeRTOS will break Arduino <code>millis()</code> and <code>micros()</code>, as these functions rely on Timer0. Functions relying on these Arduino features need to be overridden.</p>
<h1><a class="anchor" id="autotoc_md22"></a>
WDT (default)</h1>
<p>Time slices can be selected from 15ms up to 500ms. Slower time slicing can allow the Arduino MCU to sleep for longer, without the complexity of a Tickless idle.</p>
<p>Watchdog period options:</p><ul>
<li><code>WDTO_15MS</code> (default)</li>
<li><code>WDTO_30MS</code></li>
<li><code>WDTO_60MS</code></li>
<li><code>WDTO_120MS</code></li>
<li><code>WDTO_250MS</code></li>
<li><code>WDTO_500MS</code></li>
<li><code>WDTO_1S</code></li>
<li><code>WDTO_2S</code></li>
</ul>
<h2><a class="anchor" id="autotoc_md23"></a>
WDT precision limitations</h2>
<p>The frequency of the Watchdog Oscillator is voltage and temperature dependent as shown in “Typical Characteristics” on corresponding figures:</p>
<p><img src="https://user-images.githubusercontent.com/35344069/224619444-3c0b634c-f460-40d2-8a73-256bad0d5ba1.png" alt="WDT limitations" class="inline"/></p>
<p>Timing consistency may vary as much as 20% between two devices in same setup due to individual device differences, or between a prototype and production device due to setup differences.</p>
<h1><a class="anchor" id="autotoc_md24"></a>
Alternative tick sources</h1>
<p>For applications requiring high precision timing, the Ticks can be sourced from one of the hardware timers or an external clock input.</p>
<p>First, you switch it in <code><a class="el" href="../../d0/dce/_free_r_t_o_s_variant_8h_source.html">FreeRTOSVariant.h</a></code> header by removing or undefining <code>portUSE_WDTO</code> and defining, here for example, the 8-bit Timer0 <code>portUSE_TIMER0</code>.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#undef portUSE_WDTO</span></div>
<div class="line"><span class="preprocessor">#define portUSE_TIMER0</span></div>
</div><!-- fragment --><p>Next, in your app you provide two pieces of code: the initialisation functions and the ISR hook. Their implementation depends on your tick source.</p>
<h1><a class="anchor" id="autotoc_md25"></a>
Timer specific initialisation and ISR functions</h1>
<p>For implementation examples for many different timers, including the RTC Timer2 available on some devices, please refer to <code>port.c</code> in the <a href="https://github.com/feilipu/avrfreertos/tree/master/freeRTOS10xx/portable">AVRfreeRTOS Repository</a>.</p>
<h2><a class="anchor" id="autotoc_md26"></a>
Hardware timer Timer0</h2>
<p><em>NOTE: This code snippet is verified to work on Atmega2560. Full code available <a href="../.././tick_sources_timer0.cpp">here</a>.</em></p>
<div class="fragment"><div class="line"><span class="comment">// Formula for the frequency is:</span></div>
<div class="line"><span class="comment">//      f = F_CPU / (PRESCALER * (1 + COUNTER_TOP)</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Assuming the MCU clock of 16MHz, prescaler 1024 and counter top 249, the resulting tick period is 16 ms (62.5 Hz).</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="preprocessor">#define TICK_PERIOD_16MS     249</span></div>
<div class="line"><span class="preprocessor">#define PRESCALER            1024</span></div>
<div class="line"><span class="preprocessor">#if (portTICK_PERIOD_MS != (PRESCALER * (1 + TICK_PERIOD_16MS) * 1000 / F_CPU))</span></div>
<div class="line"><span class="preprocessor">    #warning portTICK_PERIOD_MS defined in FreeRTOSVariant.h differs from your timer configuration</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// For register TCCR0A:</span></div>
<div class="line"><span class="preprocessor">#define NO_PWM              (0 &lt;&lt; COM0A1) | (0 &lt;&lt; COM0A0) | (0 &lt;&lt; COM0B1) | (0 &lt;&lt; COM0B0)</span></div>
<div class="line"><span class="preprocessor">#define MODE_CTC_TCCR0A     (1 &lt;&lt; WGM01) | (0 &lt;&lt; WGM00)</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// For register TCCR0B:</span></div>
<div class="line"><span class="preprocessor">#define MODE_CTC_TCCR0B     (0 &lt;&lt; WGM02)</span></div>
<div class="line"><span class="preprocessor">#define PRESCALER_1024      (1 &lt;&lt; CS02) | (0 &lt;&lt; CS01) | (1 &lt;&lt; CS00)</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// For register TIMSK0:</span></div>
<div class="line"><span class="preprocessor">#define INTERRUPT_AT_TOP    (1 &lt;&lt; OCIE0A)</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span></div>
<div class="line"><span class="keywordtype">void</span> prvSetupTimerInterrupt( <span class="keywordtype">void</span> )</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// In case Arduino platform has pre-configured the timer,</span></div>
<div class="line">    <span class="comment">// disable it before re-configuring here to avoid unpredicted results:</span></div>
<div class="line">    TIMSK0 = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Now configure the timer:</span></div>
<div class="line">    TCCR0A = NO_PWM | MODE_CTC_TCCR0A;</div>
<div class="line">    TCCR0B = MODE_CTC_TCCR0B | PRESCALER_1024;</div>
<div class="line">    OCR0A = TICK_PERIOD_16MS;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Prevent missing the top and going into a possibly long wait until wrapping around:</span></div>
<div class="line">    TCNT0 = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// At this point the global interrupt flag is NOT YET enabled,</span></div>
<div class="line">    <span class="comment">// so you&#39;re NOT starting to get the ISR calls until FreeRTOS enables it just before launching the scheduler.</span></div>
<div class="line">    TIMSK0 = INTERRUPT_AT_TOP;</div>
<div class="line">}</div>
</div><!-- fragment --><p>To switch to an alternative tick source, here for example Timer0, insert this block in <code><a class="el" href="../../d0/dce/_free_r_t_o_s_variant_8h_source.html">FreeRTOSVariant.h</a></code>:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#undef portUSE_WDTO</span></div>
<div class="line"><span class="preprocessor">#define portUSE_TIMER0</span></div>
<div class="line"><span class="preprocessor">#define portTICK_PERIOD_MS 16</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * When a tick source other than WDT is used, configuring the tick source becomes the user&#39;s responsibility.</span></div>
<div class="line"><span class="comment"> * E.g., when using Timer0 for the tick source, you can use the following snippet:</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Formula for the frequency is:</span></div>
<div class="line"><span class="comment">//      f = F_CPU / (PRESCALER * (1 + COUNTER_TOP)</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// Assuming the MCU clock of 16MHz, prescaler 1024 and counter top 249, the resulting tick period is 16 ms (62.5 Hz).</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define TICK_PERIOD_16MS     249</span></div>
<div class="line"><span class="preprocessor">#define PRESCALER            1024</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if (portTICK_PERIOD_MS != (PRESCALER * (1 + TICK_PERIOD_16MS) * 1000 / F_CPU))</span></div>
<div class="line"><span class="preprocessor">    #warning portTICK_PERIOD_MS defined in FreeRTOSVariant.h differs from your timer configuration</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> *</div>
<div class="line"><span class="comment">// For register TCCR0A:</span></div>
<div class="line"><span class="preprocessor">#define NO_PWM              (0 &lt;&lt; COM0A1) | (0 &lt;&lt; COM0A0) | (0 &lt;&lt; COM0B1) | (0 &lt;&lt; COM0B0)</span></div>
<div class="line"><span class="preprocessor">#define MODE_CTC_TCCR0A     (1 &lt;&lt; WGM01) | (0 &lt;&lt; WGM00)</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// For register TCCR0B:</span></div>
<div class="line"><span class="preprocessor">#define MODE_CTC_TCCR0B     (0 &lt;&lt; WGM02)</span></div>
<div class="line"><span class="preprocessor">#define PRESCALER_1024      (1 &lt;&lt; CS02) | (0 &lt;&lt; CS01) | (1 &lt;&lt; CS00)</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// For register TIMSK0:</span></div>
<div class="line"><span class="preprocessor">#define INTERRUPT_AT_TOP    (1 &lt;&lt; OCIE0A)</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span></div>
<div class="line"><span class="keywordtype">void</span> prvSetupTimerInterrupt( <span class="keywordtype">void</span> )</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// In case Arduino platform has pre-configured the timer,</span></div>
<div class="line">    <span class="comment">// disable it before re-configuring here to avoid unpredicted results:</span></div>
<div class="line">    TIMSK0 = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Now configure the timer:</span></div>
<div class="line">    TCCR0A = NO_PWM | MODE_CTC_TCCR0A;</div>
<div class="line">    TCCR0B = MODE_CTC_TCCR0B | PRESCALER_1024;</div>
<div class="line">    OCR0A = TICK_PERIOD_16MS;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Prevent missing the top and going into a possibly long wait until wrapping around:</span></div>
<div class="line">    TCNT0 = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// At this point the global interrupt flag is NOT YET enabled,</span></div>
<div class="line">    <span class="comment">// so you&#39;re NOT starting to get the ISR calls until FreeRTOS enables it just before launching the scheduler.</span></div>
<div class="line">    TIMSK0 = INTERRUPT_AT_TOP;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Though Timer0 is given as example here, any timer can be used. A 16-bit timer (e.g., Timer1) is needed for time slices longer than ~20 milliseconds.</p>
<h2><a class="anchor" id="autotoc_md27"></a>
Hardware timer ISR hook</h2>
<p>For <b>preemptive</b> scheduler use <code>ISR_NAKED</code> attribute to reduce the call overhead:</p>
<div class="fragment"><div class="line">ISR(TIMER0_COMPA_vect, ISR_NAKED) __attribute__ ((hot, flatten));</div>
<div class="line">ISR(TIMER0_COMPA_vect) {</div>
<div class="line">    vPortYieldFromTick();</div>
<div class="line">    __asm__ __volatile__ ( <span class="stringliteral">&quot;reti&quot;</span> );</div>
<div class="line">}</div>
</div><!-- fragment --><p>The register context is saved at the start of <code>vPortYieldFromTick()</code>, then the tick count is incremented, finally the new context is loaded - so no dirtying occurs.</p>
<p>For <b>cooperative</b> scheduler, the register context is not saved because no switching is intended; therefore <code>naked</code> attribute cannot be applied because cooperative <code>xTaskIncrementTick()</code> dirties the context.</p>
<div class="fragment"><div class="line">ISR(TIMER0_COMPA_vect) __attribute__ ((hot, flatten));</div>
<div class="line">ISR(TIMER0_COMPA_vect) {</div>
<div class="line">    xTaskIncrementTick();</div>
<div class="line">}</div>
</div><!-- fragment --><p>Use <code>ISR_NOBLOCK</code> where there is an important timer running, that should preempt the scheduler: </p><div class="fragment"><div class="line">ISR(portSCHEDULER_ISR, ISR_NAKED ISR_NOBLOCK) __attribute__ ((hot, flatten));</div>
</div><!-- fragment --><p>The attributes <code>hot</code> and <code>flatten</code> help inlining all the code found inside your ISR thus reducing the call overhead. Note: NO comma before <code>ISR_NOBLOCK</code>.</p>
<h2><a class="anchor" id="autotoc_md28"></a>
External clock</h2>
<p><em>NOTE: This code snippet example has not been verified to work.</em></p>
<p>Assuming the external clock is connected to data pin 21 (external interrupt <code>INT0</code>):</p>
<div class="fragment"><div class="line"><span class="comment">// For register EICRA:</span></div>
<div class="line"><span class="preprocessor">#define TICK_ON_RISING_EDGE_D21   (1 &lt;&lt; ISC01) | (1 &lt;&lt; ISC00)</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// For register EIMSK:</span></div>
<div class="line"><span class="preprocessor">#define TICK_INPUT_PIN_D21     (1 &lt;&lt; INT0)</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span></div>
<div class="line"><span class="keywordtype">void</span> prvSetupTimerInterrupt( <span class="keywordtype">void</span> )</div>
<div class="line">{</div>
<div class="line">    EICRA = TICK_ON_RISING_EDGE_D21;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// At this point the global interrupt flag is NOT YET enabled,</span></div>
<div class="line">    <span class="comment">// so you&#39;re NOT starting to get the ISR calls until FreeRTOS enables it just before launching the scheduler.</span></div>
<div class="line">    EIMSK = TICK_INPUT_PIN_D21;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Configure the pin</span></div>
<div class="line">    pinMode(21, INPUT);</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md29"></a>
External clock ISR hook</h2>
<p>Similar to Timer0 ISR, for <b>preemptive</b> scheduler:</p>
<div class="fragment"><div class="line">ISR(INT0_vect, ISR_NAKED) __attribute__ ((hot, flatten));</div>
<div class="line">ISR(INT0_vect) {</div>
<div class="line">    vPortYieldFromTick();</div>
<div class="line">    __asm__ __volatile__ ( <span class="stringliteral">&quot;reti&quot;</span> );</div>
<div class="line">}</div>
</div><!-- fragment --><p>For <b>cooperative</b> scheduler: </p><div class="fragment"><div class="line">ISR(INT0_vect) __attribute__ ((hot, flatten));</div>
<div class="line">ISR(INT0_vect) {</div>
<div class="line">    xTaskIncrementTick();</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md30"></a>
Performance considerations</h1>
<p>When selecting the duration for the time slice, the following should be kept in mind.</p>
<h2><a class="anchor" id="autotoc_md31"></a>
Granularity</h2>
<p>Note that Timer resolution (or granularity) is affected by integer maths division and the time slice selected. For example, trying to measure 50ms using a 120ms time slice won't work.</p>
<h2><a class="anchor" id="autotoc_md32"></a>
Context switching</h2>
<p>In preemptive mode, tasks which are actively executing (i.e., those not waiting for a semaphore or queue) might be switched every time tick, depending on their priority. Switching the context involves pushing all CPU's registers of old task and popping all registers of new task. The shorter your time slice is, the bigger of overhead this becomes.</p>
<p>In cooperative mode, context overhead is not a factor.</p>
<h2><a class="anchor" id="autotoc_md33"></a>
Calculations</h2>
<p>On MCUs lacking the hardware division operation like AVR, a special care should be taken to avoid division operations. Where unavoidable, operations with divisor of power of 2 work best because they are performed with bitwise shifting, whereas an arbitrary value results in a software division operation taking ~200 clock cycles (for a <code>uint16_t</code> operand).</p>
<p>You might encounter a division when calculating delays, e.g. converting milliseconds to ticks:</p>
<div class="fragment"><div class="line">TickType_t ticks = delay_millis / portTICK_PERIOD_MS</div>
</div><!-- fragment --><p>If your application needs to do this sort of conversion a lot, consider making your time slice a power-of-2 value (16 ms, 32 ms, 64 ms etc.). </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue Apr 8 2025 17:22:08 for SafeTown Senior Robot by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
